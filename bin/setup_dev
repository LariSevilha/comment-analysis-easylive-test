#!/usr/bin/env bash
# Setup script for development environment

set -e

echo "ğŸš€ Setting up Comment Analysis Pipeline development environment..."

# Check Ruby version
echo "ğŸ“‹ Checking Ruby version..."
if ! ruby -v | grep -q "ruby 3"; then
  echo "âŒ Ruby 3.0+ is required. Current version: $(ruby -v)"
  exit 1
fi
echo "âœ… Ruby version OK: $(ruby -v)"

# Check if PostgreSQL is running
echo "ğŸ“‹ Checking PostgreSQL..."
if ! pg_isready -q; then
  echo "âŒ PostgreSQL is not running. Please start PostgreSQL service."
  exit 1
fi
echo "âœ… PostgreSQL is running"

# Install dependencies
echo "ğŸ“¦ Installing Ruby gems..."
bundle install

# Setup environment file
if [ ! -f .env ]; then
  echo "ğŸ“ Creating .env file..."
  cp .env.example .env
  echo "âš ï¸  Please edit .env file with your configuration"
else
  echo "âœ… .env file already exists"
fi

# Setup database
echo "ğŸ—„ï¸  Setting up database..."
bundle exec rails db:create
bundle exec rails db:migrate
bundle exec rails db:seed

# Run tests to verify setup
echo "ğŸ§ª Running tests to verify setup..."
bundle exec rails test

echo ""
echo "ğŸ‰ Setup completed successfully!"
echo ""
echo "ğŸ“‹ Next steps:"
echo "  1. Edit .env file with your API keys"
echo "  2. Start the server: rails server"
echo "  3. Start background jobs: bundle exec solid_queue:start"
echo "  4. Visit http://localhost:3000 to test the API"
echo ""
echo "ğŸ“š Useful commands:"
echo "  â€¢ rails console                    # Open Rails console"
echo "  â€¢ rails test                       # Run tests"
echo "  â€¢ rails db:seed                    # Load sample data"
echo "  â€¢ bundle exec solid_queue:start    # Start background jobs"
echo ""